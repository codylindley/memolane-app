m.utilities={breakURLCache:function(e){return e+"?breakCache="+(new Date).getTime()},browser:{init:function(){this.browser=this.searchString(this.dataBrowser)||$.i18n.t("An unknown browser","this message informs the user that we weren't able to identify the browser they're using");this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||$.i18n.t("an unknown version","this message informs the user that we weren't able to identify the version of the browser they're using");
this.OS=this.searchString(this.dataOS)||$.i18n.t("an unknown OS","this message informs the user that we weren't able to identify the operating system they're using")},searchString:function(e){for(var a=0;a<e.length;a++){var b=e[a].string,c=e[a].prop;this.versionSearchString=e[a].versionSearch||e[a].identity;if(b){if(b.indexOf(e[a].subString)!=-1)return e[a].identity}else if(c)return e[a].identity}},searchVersion:function(e){var a=e.indexOf(this.versionSearchString);return a==-1?void 0:parseFloat(e.substring(a+
this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",
identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,
subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]},capitalizeString:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},wait:function(e){return $.Deferred(function(a){setTimeout(a.resolve,e)})},dateFormatRelative:function(e){var e=new Date(e*1E3),a=new Date,b="",b=(a.getTime()-e.getTime())/6E4,c=a.getHours()*60+a.getMinutes();return b=e.getYear()<a.getYear()?this.dateFormat(e,
"mmm d, yyyy",false):b-c>1440?this.dateFormat(e,"mmm d",false):b-c>0?$.i18n.t("yesterday"):Math.floor(b)<=0?$.i18n.t("seconds ago","indicating that something happened within the last 60 seconds"):b<60?$.i18n.t("%s min ago","number of minutes since something",[Math.floor(b)]):$.i18n.t("%s hrs ago","number of hours since something",[Math.floor(b/60)])},cleanMemoId:function(e){return e.replace(/[:=-_@\.\/]/g,"")},dateFormat:function(){var e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
a=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,b=/[^-+\dA-Z]/g,c=function(a,b){a=String(a);for(b=b||2;a.length<b;)a="0"+a;return a};return function(d,n,g){var f,k,j;d==0&&(d=1);j={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",shortDateWithZero:"mm/dd/yyyy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",fullDatePlusTime:"dddd, mmmm d - h:MM tt",fullDateAndTime:"mm/dd/yyyy hh:MM:ss TT",
dateTimeForMemoChangeDate:"m-d-yyyy hh:MM:ss TT",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};f=[$.i18n.t("Sun","shorthand for Sunday"),$.i18n.t("Mon","shorthand for Monday"),$.i18n.t("Tue","shorthand for Tuesday"),$.i18n.t("Wed","shorthand for Wednesday"),$.i18n.t("Thu","shorthand for Thursday"),$.i18n.t("Fri","shorthand for Friday"),$.i18n.t("Sat","shorthand for Saturday"),
$.i18n.t("Sunday"),$.i18n.t("Monday"),$.i18n.t("Tuesday"),$.i18n.t("Wednesday"),$.i18n.t("Thursday"),$.i18n.t("Friday"),$.i18n.t("Saturday")];k=[$.i18n.t("Jan","shorthand for January"),$.i18n.t("Feb","shorthand for February"),$.i18n.t("Mar","shorthand for March"),$.i18n.t("Apr","shorthand for April"),$.i18n.t("May","shorthand for May"),$.i18n.t("Jun","shorthand for June"),$.i18n.t("Jul","shorthand for July"),$.i18n.t("Aug","shorthand for August"),$.i18n.t("Sep","shorthand for September"),$.i18n.t("Oct",
"shorthand for October"),$.i18n.t("Nov","shorthand for November"),$.i18n.t("Dec","shorthand for December"),$.i18n.t("January"),$.i18n.t("February"),$.i18n.t("March"),$.i18n.t("April"),$.i18n.t("May"),$.i18n.t("June"),$.i18n.t("July"),$.i18n.t("August"),$.i18n.t("September"),$.i18n.t("October"),$.i18n.t("November"),$.i18n.t("December")];arguments.length==1&&Object.prototype.toString.call(d)=="[object String]"&&!/\d/.test(d)&&(n=d,d=void 0);d=d?new Date(d):new Date;if(isNaN(d))throw SyntaxError("invalid date");
n=String(j[n]||n||j["default"]);n.slice(0,4)=="UTC:"&&(n=n.slice(4),g=true);var h=g?"getUTC":"get";j=d[h+"Date"]();var i=d[h+"Day"](),l=d[h+"Month"](),p=d[h+"FullYear"](),o=d[h+"Hours"](),r=d[h+"Minutes"](),s=d[h+"Seconds"](),h=d[h+"Milliseconds"](),q=g?0:d.getTimezoneOffset(),t={d:j,dd:c(j),ddd:f[i],dddd:f[i+7],m:l+1,mm:c(l+1),mmm:k[l],mmmm:k[l+12],yy:String(p).slice(2),yyyy:p,h:o%12||12,hh:c(o%12||12),H:o,HH:c(o),M:r,MM:c(r),s:s,ss:c(s),l:c(h,3),L:c(h>99?Math.round(h/10):h),t:o<12?"a":"p",tt:o<
12?"am":"pm",T:o<12?"A":"P",TT:o<12?"AM":"PM",Z:g?"UTC":(String(d).match(a)||[""]).pop().replace(b,""),o:(q>0?"-":"+")+c(Math.floor(Math.abs(q)/60)*100+Math.abs(q)%60,4),S:["th","st","nd","rd"][j%10>3?0:(j%100-j%10!=10)*j%10]};return n.replace(e,function(a){return a in t?t[a]:a.slice(1,a.length-1)})}}(),convertURLstringsToAnchors:function(e,a){var b='<a href="$1" target="_blank">$1</a>';a&&(b='<span class="aStyle">$1</span>');return e.replace(/((http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?)/ig,
b)},linkify:function(e){return e.replace(/(\()((?:ht|f)tps?:\/\/[a-z0-9\-._~!$&'()*+,;=:\/?#[\]@%]+)(\))|(\[)((?:ht|f)tps?:\/\/[a-z0-9\-._~!$&'()*+,;=:\/?#[\]@%]+)(\])|(\{)((?:ht|f)tps?:\/\/[a-z0-9\-._~!$&'()*+,;=:\/?#[\]@%]+)(\})|(<|&(?:lt|#60|#x3c);)((?:ht|f)tps?:\/\/[a-z0-9\-._~!$&'()*+,;=:\/?#[\]@%]+)(>|&(?:gt|#62|#x3e);)|((?:^|[^=\s'"\]])\s*['"]?|[^=\s]\s+)(\b(?:ht|f)tps?:\/\/[a-z0-9\-._~!$'()*+,;=:\/?#[\]@%]+(?:(?!&(?:gt|#0*62|#x0*3e);|&(?:amp|apos|quot|#0*3[49]|#x0*2[27]);[.!&',:?;]?(?:[^a-z0-9\-._~!$&'()*+,;=:\/?#[\]@%]|$))&[a-z0-9\-._~!$'()*+,;=:\/?#[\]@%]*)*[a-z0-9\-_~$()*+=\/#[\]@%])/img,
'$1$4$7$10$13<a href="$2$5$8$11$14">$2$5$8$11$14</a>$3$6$9$12')},linkifyHtml:function(e){e=e.replace(/&amp;apos;/g,"&#39;");section_html_pattern=/([^<]+(?:(?!<a\b)<[^<]*)*|(?:(?!<a\b)<[^<]*)+)|(<a\b[^>]*>[^<]*(?:(?!<\/a\b)<[^<]*)*<\/a\s*>)/ig;return e.replace(section_html_pattern,_linkify_html_callback)},urlHash:{set:function(e){var e=$.toQueryParams(e),a=$.toQueryParams(location.hash),b;for(b in e)a[b]=e[b];return $.toQueryString(a)},remove:function(e){var e=$.toQueryParams(e),a=$.toQueryParams(location.hash),
b={},c;for(c in a)e[c]==void 0&&(b[c]=a[c]);return $.toQueryString(b)},get:function(e){var a;a=m.embeddedParams&&typeof m.embeddedParams.memo_hash!="undefined"&&m.embeddedParams.memo_hash!=""?m.embeddedParams.memo_hash:location.hash;return typeof e=="undefined"?$.toQueryParams(a):$.toQueryParams(a)[e]},go:function(e){location.hash=e.substr(0,1)=="#"?e:"#"+e;return false}},getMessages:function(){$(window).bind("message",function(e){for(name in e.originalEvent.data){if(name.match(/custom_hostname/))m.embeddedParams.custom_hostname=
e.originalEvent.data[name];if(name.match(/custom_pathname/))m.embeddedParams.custom_pathname=e.originalEvent.data[name]}$(window).unbind("message");return true})},fixedModulus:function(e,a){return(e%a+a)%a}};
m.globalTemplates={dialogs:{removeLane:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+$.i18n.t("Remove Lane")+'</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+$.i18n.t("cancel","close remove lane dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>'+$.i18n.t("Are you sure you want to remove")+' "${title}" '+$.i18n.t("from Memolane?")+"</strong></p>\t\t<p>"+$.i18n.t("All settings will be lost, and any work you've put into curating this lane will be permanently gone!")+
'</p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">'+$.i18n.t("Yes, REMOVE the lane")+'</a> <a href="#" class="secondaryAction float-left close">'+$.i18n.t("No, I don't want that")+"</a></p>\t</div></div>",removeLaneContributor:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+$.i18n.t("Stop Contributing?")+'</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+$.i18n.t("cancel","close remove lane contributor dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>'+
$.i18n.t("Are you sure you wish to stop contributing to this lane:")+' ${lane_title}</strong></p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">'+$.i18n.t("Remove me as a contributor from this lane")+'</a> <a href="#" class="secondaryAction float-left close">'+$.i18n.t("No, I don't want that")+"</a></p>\t</div></div>",addFriend:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+$.i18n.t("Friend Request Sent")+'</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+
$.i18n.t("close","close dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>'+$.i18n.t("Cross your fingers!")+"</strong></p>\t\t<p>"+$.i18n.t("You just sent a friend request to")+' ${first_name} ${last_name}.</p>\t\t<p><a href="#" class="btn-green float-left close">'+$.i18n.t("OK","ok button for dialog")+"</a></p>\t</div></div>",acceptFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Accepted Friend Request</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+
$.i18n.t("close","close dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>'+$.i18n.t("We're friends!</strong>")+"</p>\t\t<p>"+$.i18n.t("You just accepted <strong>${full_name}'s</strong> friend request!")+"</p>\t\t<p>"+$.i18n.t('You can now see each other\'s "Friends Only" memos.')+'</p>\t\t<p><a href="#" class="btn-green float-left close">'+$.i18n.t("OK","ok button for dialog")+"</a></p>\t</div></div>",rejectFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+
$.i18n.t("Ignored Friend Request")+'</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+$.i18n.t("close","close dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>'+$.i18n.t("It's not you, it's me")+"</strong></p>\t\t<p>"+$.i18n.t("You just ignored <strong>${full_name}'s</strong> friend request.")+"</p>\t\t<p>"+$.i18n.t("At this point, you can only see each other's public memos.")+"</p>\t</div></div>",cancelFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+
$.i18n.t("Cancelled Friend Request")+'</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+$.i18n.t("close","close dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>'+$.i18n.t("It's not you, it's me")+"</strong></p>\t\t<p>"+$.i18n.t("You just cancelled your request for <strong>${full_name}'s</strong> friendship.")+"</p>\t\t<p>"+$.i18n.t("At this point, you can only see each other's public memos.")+"</p>\t</div></div>",removeFriend:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+
$.i18n.t("Remove Friend?")+'</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+$.i18n.t("cancel","close remove friend dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>'+$.i18n.t("Are you sure you want to cancel your Memolane friendship with")+" ${full_name}</strong>?</p>\t\t<p>"+$.i18n.t("You and")+" ${full_name} "+$.i18n.t("will lose the ability to see each other's \"Friends Only\" memos and contribute to each other's lanes.")+
'</p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">'+$.i18n.t("Yes, REMOVE the friend")+'</a> <a href="#" class="secondaryAction float-left close">'+$.i18n.t("No, I don't want that")+"</a></p>\t</div></div>",genericListOfUsersDialog:'<div id="list-users" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">${$item.dialogTitle}</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+$.i18n.t("close","close dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent"><ul>\t{{each liked_by}}\t\t<li class="clearfix">\t\t<a href="/${user.username}" title="'+
$.i18n.t("view user profile")+'">\t\t<img src="/${user.username}/images" height="20" width="20" class="search-result-icon search-user-avatar" alt="'+$.i18n.t("top bar avatar","this labels the lane avatar")+'"/>\t\t<span class="list-user-fullname-username">\t\t${user.full_name}\t\t<span class="list-users-username">(${user.username})</span>\t\t<span class="list-users-date">'+$.i18n.t("Liked ")+" ${m.utilities.dateFormatRelative(timestamp)}</span>\t\t</span> </a></li>\t{{/each}}</ul>\t</div></div>"}};
m.deviceIsIpad=navigator.userAgent.match(/iPad/i)!=null;m.deviceIsIphone=navigator.userAgent.match(/iPhone/i)!=null;m.deviceIsAndroid=navigator.userAgent.toLowerCase().indexOf("android")>-1;m.isIE9=$.browser.version==="9.0"?true:false;m.isIE8=$.browser.version==="8.0"?true:false;m.clickOrTouchStart=Modernizr.touch?"touchstart":"click";m.clickOrTouchEnd=Modernizr.touch?"touchend":"click";m.mouseEnterOrTouchStart=Modernizr.touch?"touchstart":"mouseenter";
m.mouseLeaveOrTouchEnd=Modernizr.touch?"touchend":"mouseleave";m.mouseDownOrTouchStart=Modernizr.touch?"touchstart":"mousedown";m.mouseMoveOrTouchMove=Modernizr.touch?"touchmove":"mousemove";m.mouseUpOrTouchEnd=Modernizr.touch?"touchend":"mouseup";m.mouseOutOrTouchEnd=Modernizr.touch?"touchend":"mouseout";m.mouseOverOrTouchStart=Modernizr.touch?"touchstart":"mouseover";
m.language=function(e,a){return{$langSettings:a("#language-settings"),initialize:function(){this.$langSettings.bind(m.clickOrTouchStart,this.openLangSettingsDialog)},openLangSettingsDialog:function(){a('<div id="language-settings-dialog" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+a.i18n.t("Language Settings")+'</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">'+a.i18n.t("cancel","cancel dialog actions")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t<p>'+
a.i18n.t("Select your preferred language:")+'</p>\t<ul>\t<li><label id="en-flag"><input type="radio" value="en" name="language-selected" /></li></label>\t<li><label id="ja-flag"><input type="radio" value="ja" name="language-selected" /></li></label>\t</ul> \t<div class="clear"></div>\t<p><a href="#" id="change-language-btn" class="btn-green float-left close">'+a.i18n.t("OK","ok button for dialog")+"</a></p>\t</div></div>").find("input").each(function(){a(this).val()===m.currentLanguage&&a(this).prop("checked",
true)}).end().find("#change-language-btn").click(function(){var b=a(this).closest(".dialogContent").find("input:checked").val(),c=e.location.hash||"";e.location.href=e.location.href.split("#")[0].split("?")[0]+"?lang="+b+c}).end().lightbox_me({centered:true});return false}}}(this,jQuery,this.undefined);m.language.initialize();
m.topBar=function(e,a){return{initialize:function(){a(e).bind("resize",function(){m.topBar.runLayout()});this.runLayout()},runLayout:function(){var b=a("body"),c=a("#header"),d=a("#tb-search input");b.width()<1E3&&(c.removeClass("more1024").addClass("less1024"),d.attr("value",a.i18n.t("Search","term used to label search box")));b.width()>=1E3&&(c.removeClass("less1024").addClass("more1024"),m.currentLane?d.attr("value",a.i18n.t("Search memos, lanes & users")):d.attr("value",a.i18n.t("Search lanes & users")))}}}(this,
jQuery,this.undefined);m.topBar.initialize();
m.topBarDropDowns=function(e,a){return{$tbDropDowns:a(".tb-dropdown"),$dropDowns:a(".dd-container"),$dropDownsListContent:a(".dd-list-content"),jScrollGutter:5,loaderClass:"small-loader-on-grey",ddListHeight:350,ddWaitHeight:100,friendsContext:"main",friendRequests:0,hashOnPageLoad:window.location.hash.substring(1).toLowerCase(),initialize:function(){var b=this;this.$tbDropDowns.bind(m.clickOrTouchStart,a.proxy(this.initDD,this));this.$dropDownsListContent.jScrollPane({verticalGutter:b.jScrollGutter});a(document).bind(m.clickOrTouchStart,
a.proxy(this.closeAllDropdownsFromClickOff,this));this.$dropDownsListContent.delegate(".dd-friends-remove",m.clickOrTouchStart,function(){b.removeFriendDialog(a(this));return false}).delegate(".dd-friends-pending-remove",m.clickOrTouchStart,function(c){b.removeFriendPendingRequest(c,a(this));return false}).delegate(".dd-friends-friend-yes",m.clickOrTouchStart,function(c){b.acceptFriendRequest(c,a(this));return false}).delegate(".dd-friends-friend-no",m.clickOrTouchStart,function(c){b.rejectFriendRequest(c,
a(this));return false}).delegate(".dd-lanes-remove",m.clickOrTouchStart,function(){b.removeLaneDialog(a(this));return false}).delegate(".dd-lanes-fav-remove",m.clickOrTouchStart,function(){b.removeLaneFav(a(this));return false}).delegate(".dd-lanes-edit",m.clickOrTouchStart,function(){b.editLane(a(this))}).delegate(".dd-lanes-remove-contrib",m.clickOrTouchStart,function(){b.removeLaneContributorDialog(a(this));return false});a(".dd-friends-types").delegate("a",m.clickOrTouchStart,function(a){b.toggleFriendsTypes(a);
return false});this.getNewNewsNumber();this.getIncomingFriendsRequestsNumber();if(this.hashOnPageLoad){var c=m.utilities.urlHash.get("topBar");c&&setTimeout(function(){switch(c){case "getFriends":a("#dd-friends-button").trigger("click");break;case "getNews":a("#dd-news-button").trigger("click");break;case "getLanes":a("#dd-lanes-button").trigger("click")}},1500)}a("#dd-lanes .smallButtonBar li a").bind(m.clickOrTouchStart,function(){var c=a(this);if(c.hasClass("smallButtonActive"))return false;var e=
a(this).parent().attr("id");c.closest("ul").find("a").removeClass("smallButtonActive").end().end().addClass("smallButtonActive");a("#dd-fav-lanes,#dd-your-lanes").hide();a("#"+e.slice(0,e.indexOf("-btn"))).addClass("visibility-hidden").show().height(100);c=a("#"+e.slice(0,e.indexOf("-btn"))+" ul").height();c=c>400?400:c;a("#"+e.slice(0,e.indexOf("-btn"))).show().css("height",c+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).removeClass("visibility-hidden").find(".jspVerticalBar").removeClass("visibility-hidden");
return false})},initDD:function(b){var b=a(b.currentTarget),c=b.attr("data-ddid"),d=a("#"+c),e=a(".dd-container");if(d.css("visibility")==="visible")return this.closeDropdown(b,d),false;else{switch(c){case "dd-friends":this.getFriends();break;case "dd-lanes":this.getLanes();break;case "dd-news":this.getNews()}e.filter(function(){return a(this).css("visibility")=="visible"}).length&&this.closeAllDropdowns();this.positionDropdown(b,d)}},getNews:function(){var b=this,c=a("#dd-news");c.find(".dd-list-content").addClass(b.loaderClass).css("height",
b.ddWaitHeight).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");b.getNewNewsNumber();a.ajax({url:"/feed",cache:false,success:function(d){for(var e=0,g=d.feed.length,f={},k=f="",j="";e<g;)f=d.feed[e],f.date_str=m.utilities.dateFormatRelative(f.created_at),j=b.templates.news[f.type],f=a("<div />").append(a.tmpl(j,f)).html(),k=f+k,e++;g===0&&(k='<li class="no-dd-list-item">'+a.i18n.t("No news yet")+"</li>");c.find(".dd-list-content ul").html(k);d=c.find(".dd-list-content ul").height();
d=d>b.ddListHeight?b.ddListHeight:d;c.find(".dd-list-content").removeClass(b.loaderClass).css("height",d+"px").jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden")}})},getNewNewsNumber:function(){var b=4;a.ajax({url:"/feed/volume",success:function(c){b=parseInt(c.volume);b>0?a("#tb-news-count").css("display","inline").children("span").text(b):a("#tb-news-count").css("display","none")}})},hideNewNewsIndicator:function(){var b=a("#tb-news-count");b.css("display")!=
"none"&&b.fadeOut()},getFriends:function(){var b=this;a("#dd-friends");var c=a(".dd-friends-main-pane"),d=a(".dd-friends-pending-pane");a(".dd-friends-types .smallButtonBar a").removeClass("smallButtonActive");a("#dd-friends-main").addClass("smallButtonActive");d.show().find("ul").empty();c.show();c.css("height",b.ddWaitHeight).addClass(b.loaderClass).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");a.ajax({url:"/friends/all",cache:false,success:function(e){var g=0,f=
{},f="",k={},j="",h="",i="",h=e.length,i=i=0,l={pending:0,requested:0,accepted:0};for(content={pending:"",accepted:"",requested:""};g<h;)f=e[g],i=f.status,l[i]++,k=b.templates.friends[i],f=a("<div />").append(a.tmpl(k,f)).html(),content[i]+=f,g++;l.requested||l.accepted?(j+=content.requested,j+=content.accepted):j='<li class="no-dd-list-item">'+a.i18n.t("You got peeps, everyone does. Why not make a friend. You can use search to find Memolane users to befriend. Or visit a user's dashboard and request some good old-fashioned friendship.")+
"</li>";h=l.pending?content.pending:'<li class="no-dd-list-item">'+a.i18n.t("At this time you haven't requested any friendships. Don't be shy, Memolane is best enjoyed with friends.")+"</li>";c.find("ul").html(j);i=c.find("ul").height();i=i>b.ddListHeight?b.ddListHeight:i;c.css("height",i+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden");d.find("ul").html(h);i=d.find("ul").height();i=i>b.ddListHeight?b.ddListHeight:
i;d.hide().css("height",i+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden");b.setNewFriendsIndicator(l.requested)}})},getIncomingFriendsRequestsNumber:function(){var b=this;a.ajax({url:"/friends/requested",cache:false,success:function(a){b.setNewFriendsIndicator(a.length)}})},setNewFriendsIndicator:function(b){this.friendRequests=b;b>0?a("#tb-friends-count").css("display","inline").children("span").text(b):a("#tb-friends-count").css("display",
"none")},toggleFriendsTypes:function(b){var c=a(b.target),d=c.attr("id").replace("dd-","");this.friendsContext=d;a("#dd-friends .dd-list-content").hide();a(".dd-"+d+"-pane").show();a(".dd-friends-types .smallButtonBar a").removeClass("smallButtonActive");c.addClass("smallButtonActive");".dd-"+d+"-pane"===".dd-friends-pending-pane"&&a(".dd-friends-pending-pane").data("jsp").reinitialise();b.preventDefault()},removeFriendDialog:function(b){var c=this,d={first_name:b.attr("data-first_name"),last_name:b.attr("data-last_name"),
full_name:b.attr("data-full_name"),username:b.attr("data-username")},b=a.tmpl(m.globalTemplates.dialogs.removeFriend,d);b.find(".removeConfirm").bind(m.clickOrTouchEnd,{something:"other"},function(a){m.dashboard?m.dashboard.removeFriend(d.username):c.removeFriend(d.username);a.preventDefault()});b.lightbox_me({centered:true})},removeFriend:function(b){var c=this;a.ajax({type:"delete",url:"/friends/"+b,success:function(){c.getFriends()}})},rejectFriendRequest:function(b,c){var d={first_name:c.attr("data-first_name"),
last_name:c.attr("data-last_name"),full_name:c.attr("data-full_name"),username:c.attr("data-username")};$dialog=a.tmpl(m.globalTemplates.dialogs.rejectFriendRequest,d);$dialog.lightbox_me({centered:true});m.dashboard?m.dashboard.removeFriend(d.username):this.removeFriend(d.username);this.getFriends();this.setNewFriendsIndicator(this.friendRequests-1)},acceptFriendRequest:function(b,c){var d={username:c.attr("data-username"),first_name:c.attr("data-first_name"),last_name:c.attr("data-last_name"),full_name:c.attr("data-full_name")};
m.dashboard?m.dashboard.acceptFriend(d.username):a.ajax({type:"post",cache:false,url:"/friends/"+d.username+"/accept",success:function(){$dialog=a.tmpl(m.globalTemplates.dialogs.acceptFriendRequest,d);$dialog.lightbox_me({centered:true})}});this.getFriends();this.setNewFriendsIndicator(this.friendRequests-1)},removeFriendPendingRequest:function(a,c){var d=c.data("username");m.dashboard?m.dashboard.removeFriend(d):this.removeFriend(d);this.getFriends()},getLanes:function(){var b=this,c=a("#dd-lanes"),
d=a("#dd-your-lanes");a("#dd-your-lanes-btn a").addClass("smallButtonActive");a("#dd-fav-lanes-btn a").removeClass("smallButtonActive");a("#dd-fav-lanes").hide().find("ul").empty();d.show().css("height",b.ddWaitHeight).addClass(b.loaderClass).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");a.ajax({url:"/"+m.currentUser.username+"/lanes",cache:false,success:function(e){e.length?a.tmpl(b.templates.lanes.main,e).appendTo(c.find("#dd-your-lanes ul")):a('<li class="no-dd-list-item">'+
a.i18n.t('Start creating a lane by clicking on the "New Lane" button above.')+"</li>").appendTo(c.find("#dd-your-lanes ul"));e=d.find("ul").height();e=e>400?400:e;c.find("#dd-your-lanes").css("height",e+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden")}});a.ajax({url:"/"+m.currentUser.username+"/favorite_lanes",cache:false,data:{username:m.currentUser.username},success:function(d){d.length?a.tmpl(b.templates.lanes.fav,
d).appendTo(c.find("#dd-fav-lanes ul")):a('<li class="no-dd-list-item">'+a.i18n.t("Add lanes to this list by going to a lane and clicking the star icon on the upper right. That way, you'll never lose track of your favorites.")+"</li>").appendTo(c.find("#dd-fav-lanes ul"))}})},removeLaneDialog:function(b){var c=this,d=b.attr("data-lane_title"),e=b.attr("data-lane_id"),d=a.tmpl(m.globalTemplates.dialogs.removeLane,{title:d});d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(d){b.closest("li").remove();
var f=a("#dd-your-lanes").find("ul").height(),f=f>400?400:f;a("#dd-your-lanes").css("height",f+"px").removeClass(c.loaderClass).jScrollPane({verticalGutter:c.jScrollGutter});m.dashUser?m.dashboard.removeLane(e):c.removeLane(e);d.preventDefault()});d.lightbox_me({centered:true})},removeLaneFav:function(b){var c=b.attr("data-lane_id");b.closest("li").remove();b=a("#dd-fav-lanes").find("ul").height();b=b>400?400:b;a("#dd-fav-lanes").css("height",b+"px").removeClass(this.loaderClass).jScrollPane({verticalGutter:this.jScrollGutter});
m.dashUser?a(".dashFaves #"+c).find(".remove-fav").trigger(m.clickOrTouchEnd):m.currentLane&&m.currentLane.id===c?a("#favorite-un-fav").trigger(m.clickOrTouchEnd):a.ajax({url:"/lanes/favorite",type:"DELETE",data:{lane_id:c}})},removeLaneContributorDialog:function(b){var c=this,d=b.attr("data-lane_title"),e=b.attr("data-lane_id"),g=b.attr("data-owner"),b="",d={lane_title:d},b=m.globalTemplates.dialogs.removeLaneContributor,d=a.tmpl(b,d);d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(a){m.dashboard?
m.dashboard.removeLaneContributor(e):c.removeLaneContributor(e,g);a.preventDefault()});d.lightbox_me({centered:true})},editLane:function(a){a=a.data("id");if(m.currentLane&&m.currentLane.id==a)return window.location="/"+m.currentUser.username+"/"+m.currentLane.title+"?e=1#drawer=edit",false},removeLane:function(b){var c=this;a.ajax({type:"delete",url:"/lanes/"+b,success:function(){if(m.currentLane&&m.currentLane.id==b)return window.location="/"+m.currentUser.username,false;else c.getLanes()}})},removeLaneContributor:function(b,
c){var d=this;a.ajax({type:"delete",url:"/lanes/contributor",data:{lane_id:b,username:m.currentUser.username},success:function(){if(m.currentLane&&m.currentLane.id==b)return window.location="/"+c+"/"+m.currentLane.title,false;else d.getLanes()}})},openDropdown:function(a,c){a.addClass("tb-dropdown-open");m.search&&m.search.closeSearchDD();c.css("visibility","visible")},closeDropdown:function(a,c){a.data("ddid")=="dd-news"&&this.hideNewNewsIndicator();a.removeClass("tb-dropdown-open");c.css("visibility",
"hidden")},closeAllDropdownsFromClickOff:function(b){a(b.target).closest(".dd-container,.tb-dropdown, .memolaneDialog").length||this.closeAllDropdowns()},closeAllDropdowns:function(){a(".dd-container").css("visibility","hidden");this.$tbDropDowns.removeClass("tb-dropdown-open")},positionDropdown:function(b,c){var b=b||a(".tb-dropdown-open"),c=c||a(".dd-container").filter(function(){return a(this).css("visibility")=="visible"}),d=b.offset().left,e=b.offset().top+45,g=a(window).width();d+c.width()>
g&&(d-=d+c.width()-g);c.css({top:e+"px",left:d+"px"});c.css("visibility")==="hidden"&&this.openDropdown(b,c);return false},templates:{news:{friendship_request:"",welcome_shout:'<li class="clearfix {{if is_new==true}}new-news{{/if}}">\t<div class="dd-news-item">\t\t<img src="/img/dropdowns/news-welcome.png">'+a.i18n.t("Welcome to Memolane. Start sharing the timeline of your social life today by spreading the word to your friends on",'followed by "Twitter and Facebook"')+'\t\t<a class="shareURL" href="#" data-share-link="/'+
(m.currentUser?m.currentUser.username:"")+'" data-share-text="'+a.i18n.t("Check out my new Memolane profile")+'" data-share-dialog-text="'+a.i18n.t("Share profile on")+'"><span class="icon"></span>'+a.i18n.t("Twitter and Facebook")+'</a>.\t</div>\t<div class="dd-news-item-date">${date_str}</div></li>',welcome_invite:'<li class="clearfix {{if is_new==true}}new-news{{/if}}">\t<div class="dd-news-item">\t\t<img src="/img/dropdowns/news-tell-friends.png">'+a.i18n.t("Tell a friend about Memolane!")+'\t</div>\t<div class="dd-news-item-date">${date_str}</div></li>',
new_user_invited_by:'<li class="clearfix {{if is_new==true}}new-news{{/if}}">\t<div class="dd-news-item">\t\t<a href="/${content.other.username}"><img src="/${content.other.username}/image"></a>'+a.i18n.t('<a href="**SEND_INVITOR_FRIEND_REQUEST**">Click here</a> to send them a friend request','note: do NOT alter the "SEND_INVITOR_FRIEND_REQUEST" text')+'\t</div>\t<div class="dd-news-item-date">${date_str}</div></li>',friendship:'<li class="clearfix {{if is_new==true}}new-news{{/if}}">\t<div class="dd-news-item">'+
a.i18n.t('<a href="/${content.friend.username}">${content.friend.full_name}</a> and <a href="/${content.other.username}">${content.other.full_name}</a> are now friends')+'\t</div>\t<div class="dd-news-item-date">${date_str}</div></li>',friendship_request_accepted:'<li class="clearfix {{if is_new==true}}new-news{{/if}}">\t<div class="dd-news-item">\t\t<a href="/${content.friend.username}"><img src="/${content.friend.username}/image"></a>'+a.i18n.t('<a href="/${content.friend.username}">${content.friend.full_name}</a> is now your friend')+
'\t</div>\t<div class="dd-news-item-date">${date_str}</div></li>',lane_new_contributor:'<li class="clearfix {{if is_new==true}}new-news{{/if}}">\t<div class="dd-news-item">\t\t<a href="/lanes/${content.lane.id}" title="'+a.i18n.t("view lane")+'">\t\t\t<img src="/lanes/${content.lane.id}/avatar.small" alt="'+a.i18n.t("top bar avatar","this labels the lane avatar")+'"/>\t\t</a>\t\t<a href="/${content.new_contributor.username}">${content.new_contributor.full_name}</a> '+a.i18n.t('has been added to the lane <span class="lane-name-DD"><a href="/lanes/${content.lane.id}" title="view lane">${content.lane.title}</a></span>',
"this phrase is preceded by the contributor's first and last name")+'\t</div><div class="dd-news-item-date">${date_str}</div></li>',added_to_lane:'<li class="clearfix {{if is_new==true}}new-news{{/if}}">\t<div class="dd-news-item">\t\t<a href="/${content.added_by.username}"><img src="/${content.added_by.username}/image"></a>\t\t<a href="/${content.added_by.username}">${content.added_by.full_name}</a> '+a.i18n.t("has added you as a contributor to the lane","this phrase is preceded by the user's first and last name")+
'\t\t <a href="/lanes/${content.lane.id}">${content.lane.title}</a></div>\t<div class="dd-news-item-date">${date_str}</div></li>'},lanes:{main:'<li class="clearfix">\t<a href="/${owner.username}/${title}" title="'+a.i18n.t("view lane")+'">\t\t<div class="dd-list-item">\t\t\t<img src="/lanes/${id}/avatar.small" alt="'+a.i18n.t("top bar avatar","this labels the lane avatar")+'"/>\t\t\t<span class="lane-name-DD">${title}</span>\t{{if role=="contributor"}}\t\t\t<span class="lane-type-DD">('+a.i18n.t("contributor",
"this label indicates that the user is a contributor to the given lane")+')</span>\t\t</div>\t\t<a href="#" class="dd-lanes-remove-contrib" data-lane_id="${id}" data-owner="${owner.username}" data-lane_title="${title}" title="'+a.i18n.t("remove my content from this lane")+'">X</a>\t{{else}}\t\t</div>\t\t<a href="#" class="dd-lanes-remove" data-lane_id="${id}" data-lane_title="${title}"  title="'+a.i18n.t("delete lane")+'">X</a>\t\t<a href="/${owner.username}/${title}#drawer=edit" class="dd-lanes-edit" title="'+
a.i18n.t("edit lane")+'" data-id="${id}">X</a>\t{{/if}}\t</a></li>',fav:'<li class="clearfix">\t<a href="/${owner.username}/${title}" title="'+a.i18n.t("view lane")+'">\t<div class="dd-list-item">\t\t<img src="/lanes/${id}/avatar.small" alt="'+a.i18n.t("top bar avatar","this labels the lane avatar")+'"/>\t\t<span class="lane-name-DD">${title}</span>\t\t<span class="lane-type-DD">'+a.i18n.t("by ${owner.full_name}")+' (${owner.username})</span>\t</div>{{if true}}\t<a href="#" class="dd-lanes-fav-remove" data-lane_id="${id}" data-lane_title="${title}"  title="'+
a.i18n.t("Remove from favorites")+'" >X</a>{{/if}}</a></li>'},friends:{accepted:'<li class="clearfix">\t<a href="/${other_username}" title="'+a.i18n.t("view dashboard")+'">\t<div class="dd-list-item">\t\t<img src="/${other_username}/image" alt="'+a.i18n.t("top bar avatar","this labels the lane avatar")+'"/>\t\t<span class="name-friends-DD">${other_full_name}</span> \t\t<span class="user-name-friends-DD">(${other_username})</span></div>\t\t<a href="#" class="dd-friends-remove" title="'+a.i18n.t("remove friend")+
'" data-username="${other_username}" data-first_name="${other_first_name}"  data-last_name="${other_last_name}" data-full_name="${other_full_name}">X</a>\t</div></a></li>',requested:'<li class="clearfix friend-request-list">\t<a href="/${other_username}" title="'+a.i18n.t("view dashboard")+'">\t\t<div class="dd-list-item">\t\t\t<img src="/${other_username}/image" alt="'+a.i18n.t("top bar avatar","this labels the lane avatar")+'"/>\t\t\t<span class="name-friends-DD">${other_full_name}</span> \t\t\t<span class="user-name-friends-DD">(${other_username})</span>\t\t</div>\t\t<a href="#" data-username="${other_username}" data-first_name="${other_first_name}" \t\t\tdata-last_name="${other_last_name}" data-full_name="${other_full_name}" class="dd-friends-friend-no" \t\t\ttitle="'+
a.i18n.t("Ignore Friendship Request")+'">'+a.i18n.t("Ignore","this is the short label for denying a friendship request")+'</a> \t\t<a href="#" data-username="${other_username}" data-first_name="${other_first_name}" data-last_name="${other_last_name}" data-full_name="${other_full_name}" class="dd-friends-friend-yes" title="'+a.i18n.t("Confirm Friendship Request")+'">Confirm</a></a></li>',pending:'<li class="clearfix">\t<a href="/${other_username}" title="'+a.i18n.t("view dashboard")+'">\t<div class="dd-list-item">\t\t<img src="/${other_username}/image" alt="'+
a.i18n.t("top bar avatar","this labels the lane avatar")+'"/>\t\t<span class="name-friends-DD">${other_full_name}</span> \t\t<span class="user-name-friends-DD">(${other_username})</span></div>\t\t<a href="#" data-username="${other_username}" class="dd-friends-pending-remove" title="'+a.i18n.t("remove friend request")+'" data-username="${other_username}" data-first_name="${other_first_name}" data-last_name="${other_last_name}" data-full_name="${other_full_name}">X</a>\t</div></a></li>'}}}}(this,jQuery,
this.undefined);m.currentUser!=null&&m.topBarDropDowns.initialize();
m.addFriends=function(e,a){return{continuePollingGmail:false,initialize:function(){var b=this;a(".addFriends").bind(m.clickOrTouchEnd,a.proxy(this.initialAddFriendsDialog,this));a("body").delegate("#addFriendsDialog input[type=checkbox]",m.clickOrTouchEnd,function(){var b=a(this).closest("div");b.find("input[type=checkbox]:checked").length?b.find(".inactive").removeClass("inactive"):b.find("a").addClass("inactive")});a("body").delegate("#addFriendsDialog .skipStep",m.clickOrTouchEnd,function(){a(this).closest("div").hide().siblings().show();
return false});a("body").delegate("#addFriendsDialog .selectAll",m.clickOrTouchEnd,function(){a(this).closest("div").find("input[type=checkbox]").prop("checked",true).end().find(".inactive").removeClass("inactive");return false});a("body").delegate("#addFriendsDialog .selectNone",m.clickOrTouchEnd,function(){a(this).closest("div").find("input[type=checkbox]").prop("checked",false).end().find("a").addClass("inactive");return false});a("body").delegate("#addFriendsDialog #gmailAddExistingFriends",m.clickOrTouchEnd,
a.proxy(this.addExisting,this));a("body").delegate("#addFriendsDialog #gmailInviteFriends",m.clickOrTouchEnd,a.proxy(this.inviteFriends,this));a("body").delegate("#addFriendsDialog #facebookAddExistingFriends",m.clickOrTouchEnd,a.proxy(this.addExisting,this));a("body").delegate("#addFriendsByEmail","keyup",function(){b.validateEmailList()?a(this).siblings(".inactive").removeClass("inactive"):a(this).siblings(".addFriendsBtnEmail").addClass("inactive")});a("body").delegate("#addFriendsDialog .addFriendsBtnEmail",
m.clickOrTouchEnd,a.proxy(this.sendEmailInvites,this));a.validity.setup({outputMode:"modal"});a.validity.patterns.emailList=/^(([a-zA-Z0-9_\-\.\+]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5}){1,25})+([\,.][ .]*(([a-zA-Z0-9_\-\.\+]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5}){1,25})+)*$/;a.validity.messages.emailList=a.i18n.t("Email invites must be formatted as a series of email addresses, separated by commas.")},validateEmailList:function(){var b=a("#addFriendsByEmail");return b.val().length?(a.validity.start(),
b.match("emailList"),a.validity.end().valid):false},sendEmailInvites:function(b){var c=this,d=a("#addFriendsByEmail").val();d.length&&this.validateEmailList()&&(d=d.replace(/ /g,"").replace(/\+/g,"%2B"),d=d.split(","),a.ajax({type:"post",url:"/add_friends/email_invite",data:{emails:d},success:function(b){a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(c.templates.emailDialogContent,b)).end().trigger("reposition")},error:function(){a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(c.templates.genericError)).end().trigger("reposition")}}));
b.preventDefault()},pollGmail:function(){var b=this;a.when(m.utilities.wait(1E3),b.checkGmail()).done(function(){b.continuePollingGmail&&b.pollGmail()})},checkGmail:function(){var b=this;a.ajax({type:"get",cache:false,url:"/add_friends/auth_gmail_verifier",success:function(c){if(c.status!="not ready")b.continuePollingGmail=false,a.ajax({type:"get",url:"/add_friends/contacts_gmail",data:{oauth_verifier:c},success:function(c){c.existing_users.length||c.users_to_invite.length?a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.GmailDialogContent,
c)).end().trigger("reposition"):c.friends.length?a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.GmailDialogError_TooPopular)).end().trigger("reposition"):a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.GmailDialogError_GenericOrNoFriends)).end().trigger("reposition")},error:function(){a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.GmailDialogError_BadKey)).end().trigger("reposition")}})},error:function(){b.continuePollingGmail=
false;a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.genericError)).end().trigger("reposition")}})},checkFacebook:function(){var b=this;a.ajax({type:"get",cache:false,url:"/add_friends/contacts_facebook",success:function(c){a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.FacebookDialogContent,c)).end().trigger("reposition")},error:function(c){a.parseJSON(c.responseText).error.type=="object_not_found"?a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.FacebookDialogError_noAccount)).end().trigger("reposition"):
a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.genericError)).end().trigger("reposition")}})},addExisting:function(){var b=this,c=a("#addFriends-existing .submitFriendship");if(c.not(".inactive)").length){var d=[];a("#addFriends-existing input[type=checkbox]:checked").each(function(){d.push(this.getAttribute("value"))});d.length&&a.ajax({type:"post",url:"/add_friends/batch_request",data:{uids:d},success:function(){c.is(".addFriendsLastStep")?a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.successMessage)).end().trigger("reposition"):
c.parent("div").hide().siblings().show()},error:function(){a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.genericError)).end().trigger("reposition")}})}return false},inviteFriends:function(){var b=this;if(a("#addFriends-invite .submitFriendship").not(".inactive)").length){var c=[];a("#addFriends-invite input[type=checkbox]:checked").each(function(){c.push(this.getAttribute("value"))});c.length&&a.ajax({type:"post",url:"/add_friends/email_invite",data:{emails:c},success:function(){a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.successMessage)).end().trigger("reposition")},
error:function(){a("#addFriendsDialog").find(".dialogContent").empty().append(a.tmpl(b.templates.genericError)).end().trigger("reposition")}})}return false},initialAddFriendsDialog:function(b){var c=this,d=a.tmpl(this.templates.addFriendsDialog);d.find(".addFriendsBtnGmail").bind(m.clickOrTouchEnd,function(){c.continuePollingGmail=true;c.pollGmail();a(this).parent().find(".loading").show()});d.find(".addFriendsBtnFacebook").bind(m.clickOrTouchEnd,function(b){c.checkFacebook();a(this).parent().find(".loading").show();
b.preventDefault()});d.lightbox_me();b.preventDefault()},templates:{addFriendsDialog:'<div id="addFriendsDialog" class="memolaneDialog" style="width:500px;">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">'+a.i18n.t("Add friends")+'</div>\t\t<div class="close closeMemolaneDialog removeService">'+a.i18n.t("cancel","close dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<div style="float:left; width:150px; text-align:center;">\t\t\t<div style="padding-bottom:20px; border-bottom:1px solid #e1e1e1;">\t\t\t\t<img src="/img/common/services/icon-gmail.png" alt="Gmail logo" style="padding-bottom:5px;" /><p style="margin-bottom:10px;">'+
a.i18n.t("Select friends from<br />your Gmail address book.")+'</p><a href="/add_friends/auth_gmail" target="_blank" class="btn-green addFriendsBtnGmail">'+a.i18n.t("Gmail","gmail web email")+'</a><img class="loading" src="/img/common/smallLoaderOnGrey.gif" />\t\t\t</div>\t\t\t<div style="margin-top:20px;">\t\t\t\t<img src="/img/common/services/icon-facebook.png" alt="Facebook logo" style="padding-bottom:5px;" /><p style="margin-bottom:10px;">'+a.i18n.t("Select friends from<br />your Facebook.")+
'</p><a href="#" class="btn-green addFriendsBtnFacebook">'+a.i18n.t("Facebook","Facebook, the online web application")+'</a><img class="loading" src="/img/common/smallLoaderOnGrey.gif" />\t\t\t</div>\t\t</div>\t\t<div style="float:left; width:270px; border-left:1px solid #e1e1e1; padding-left:20px; margin-left:20px;">\t\t\t<p>'+a.i18n.t("If you know the email addresses of the people you would like to invite to Memolane and send friend requests to, enter them below (separated by commas).")+'</p>\t\t\t<textarea id="addFriendsByEmail" style="margin-bottom:15px; width:260px; height:141px;"></textarea>\t\t\t<a href="#" class="btn-green addFriendsBtnEmail submitFriendship inactive">'+
a.i18n.t("Send e-mail invite(s)")+"</a>\t\t</div>\t</div></div>",GmailDialogContent:'{{if existing_users.length}}\t<div id="addFriends-existing" class="addFriendsStep">\t\t<p>'+a.i18n.t("These people are already on Memolane.  Select the ones you want to send a friend request to:")+"</p>\t\t{{if existing_users.length > 1}}<p>"+a.i18n.t("Select:","select either all of the items or none")+' <a href="#" class="selectAll">'+a.i18n.t("all","select all items")+'</a> | <a href="#" class="selectNone">'+a.i18n.t("none",
"select none of the items")+'</a></p>{{/if}}\t\t<ul>\t\t\t{{each existing_users}}\t\t\t\t<li><input type="checkbox" checked="checked" value="${username}" /> <img src="${image}" /> <p>${name}<br /><span>${email}</span></p></li>\t\t\t{{/each}}\t\t</ul>\t\t<a href="#" id="gmailAddExistingFriends" class="btn-green submitFriendship{{if !users_to_invite.length}} addFriendsLastStep{{/if}}">'+a.i18n.t("Send request(s) to selected friend(s)</a> or")+' {{if users_to_invite.length}}<a href="#" class="skipStep">'+
a.i18n.t("skip this step")+'</a>{{else}}<a href="#" class="close">'+a.i18n.t("close window")+'</a>{{/if}}\t</div>{{/if}}{{if users_to_invite.length}}\t<div id="addFriends-invite" class="addFriendsStep">\t\t<p>'+a.i18n.t("Everyone listed below is not on Memolane yet. Send them an invite and simultaneously ask them to be your friend.","text on the gmail friends invite dialog")+"</p>\t\t{{if users_to_invite.length > 1}}<p>"+a.i18n.t("Select:","select either all of the items or none")+' <a href="#" class="selectAll">'+
a.i18n.t("all","select all items")+'</a> | <a href="#" class="selectNone">'+a.i18n.t("none","select none of the items")+'</a></p>{{/if}}\t\t<ul>\t\t\t{{each users_to_invite}}\t\t\t\t<li><input type="checkbox" checked="checked" value="${emails[0]}" /> <img src="${image}" /> <p>${name}<br /><span>${emails[0]}</span></p></li>\t\t\t{{/each}}\t\t</ul>\t\t<a href="#" id="gmailInviteFriends" class="btn-green submitFriendship addFriendsLastStep">'+a.i18n.t("Send invite(s) to selected friend(s)</a>")+"</a> "+
a.i18n.t("or","_or_ between invite button and close link on invite friends dialog")+' <a href="#" class="close">'+a.i18n.t("close window")+"</a>\t</div>{{/if}}",GmailDialogError_BadKey:"<p>"+a.i18n.t("It looks like we're either having server issues, or you denied our request to connect to Gmail.")+"</p><p>"+a.i18n.t('Click "Add Friends" to try again.')+'</p><p style="margin-bottom:0;"><a href="#" class="btn-green close">'+a.i18n.t("OK","ok button for dialog")+"</a></p>",GmailDialogError_TooPopular:"<p>"+
a.i18n.t("It looks like you're too popular!")+"</p><p>"+a.i18n.t("You're already Memolane friends with all of your Gmail contacts!")+'</p><p style="margin-bottom:0;"><a href="#" class="btn-green close">'+a.i18n.t("OK","ok button for dialog")+"</a></p>",GmailDialogError_GenericOrNoFriends:"<p>"+a.i18n.t("It looks like either we're having a server issue, or we didn't get a list of contacts.")+"</p><p>"+a.i18n.t("You may want to check your Gmail contacts list to ensure there are email addresses there.</p>")+
'<p style="margin-bottom:0;"><a href="#" class="btn-green close">'+a.i18n.t("OK","ok button for dialog")+"</a></p>",FacebookDialogContent:'{{if existing_users && existing_users.length}}\t<div id="addFriends-existing" class="addFriendsStep addFriendsFacebook">\t\t<p>'+a.i18n.t("These people are already on Memolane.  Select the ones you want to send a friend request to:")+"</p>\t\t{{if existing_users.length > 1}}<p>"+a.i18n.t("Select:","select either all of the items or none")+' <a href="#" class="selectAll">'+
a.i18n.t("all","select all items")+'</a> | <a href="#" class="selectNone">'+a.i18n.t("none","select none of the items")+'</a></p>{{/if}}\t\t<ul>\t\t\t{{each existing_users}}\t\t\t\t<li><input type="checkbox" checked="checked" value="${username}" /> <img src="${image}" /> <p>${full_name}<br /><span>${email}</span></p></li>\t\t\t{{/each}}\t\t</ul>\t\t<a href="#" id="facebookAddExistingFriends" class="btn-green submitFriendship addFriendsLastStep">'+a.i18n.t("Send request(s) to selected friend(s)")+
"</a> "+a.i18n.t("or","_or_ between two buttons. X button or Y button")+' <a href="#" class="close">'+a.i18n.t("close window")+'</a>\t</div>{{else}}\t<div class="addFriendsStep">\t\t{{if friends && friends.length}}\t\t\t<p>'+a.i18n.t("It looks like you're already Memolane friends with all of your Facebook contacts - way to go social animal.")+"</p>\t\t{{else}}\t\t\t<p>"+a.i18n.t("Unfortunately, we were not able to find any existing Memolane users from your Facebook account.")+'</p>\t\t{{/if}}\t\t<p style="margin-bottom:0;"><a href="#" class="btn-green close">'+
a.i18n.t("OK","ok button for dialog")+"</a></p>\t</div>{{/if}}",FacebookDialogError_noAccount:"<p>"+a.i18n.t("You need to connect your Facebook account to Memolane in order to add friends from there.")+"</p><p>"+a.i18n.t('Go to your <a href="/settings/services">my services</a> page to do so.')+'</p><p style="margin-bottom:0;"><a href="#" class="btn-green close">'+a.i18n.t("OK","ok button for dialog")+"</a></p>",emailDialogContent:"{{if friends_requests_sent && friends_requests_sent.length}}\t<p>"+
a.i18n.t("The following people are already on Memolane, so we sent them a friend request instead.")+'</p>\t<ul class="noCheckbox">\t\t{{each friends_requests_sent}}\t\t\t<li><img src="${image}" /> <p class="addedFriendsEmail">${full_name}</p></li>\t\t{{/each}}\t</ul>\t<p style="margin-bottom:0;"><a href="#" class="btn-green close">'+a.i18n.t("Done","done button for dialog")+'</a></p>{{else}}\t<p>Hurray!  Your invites have been sent!</p>\t<p style="margin-bottom:0;"><a href="#" class="btn-green close">'+
a.i18n.t("OK","ok button for dialog")+"</a></p>{{/if}}",genericError:"<p>It looks like there was a problem.</p><p>"+a.i18n.t('You may want to try again in a bit, or let us know this happened (by clicking the "Feedback" link on the upper right).')+'</p><p style="margin-bottom:0;"><a href="#" class="btn-green close">'+a.i18n.t("OK","ok button for dialog")+"</a></p>",successMessage:'<p>Hurray!  Your invites have been sent!</p><p style="margin-bottom:0;"><a href="#" class="btn-green close">'+a.i18n.t("OK",
"ok button for dialog")+"</a></p>"}}}(this,jQuery,this.undefined);m.addFriends.initialize();
m.share=function(e,a){return{initialize:function(){a(".shareURL").live(m.clickOrTouchStart,a.proxy(this.shareDialog,this))},hostname:function(){return m.embeddedParams.custom_hostname!=""?m.embeddedParams.custom_hostname:window.location.hostname},pathname:function(a){return a!=null?m.embeddedParams.custom_pathname!=""?(a=a.split("?"),m.embeddedParams.custom_pathname+"?"+a[1]):a:m.embeddedParams.custom_pathname},shareDialog:function(b){var c=a(b.target),d=c.data("share-link"),e=this.hostname(),d=this.pathname(d),
g=window.location.protocol+"//"+e+d.replace(/ /g,"%20");a.tmpl(this.templates.shareLaneDialog,{url:encodeURIComponent(g),shareText:encodeURIComponent(c.data("share-text")),shareDialogText:c.data("share-dialog-text")}).find(".shareFacebook").click(function(b){window.open(a(this).attr("href"),a.i18n.t("Share on Facebook"),"width=600,height=400");b.preventDefault()}).end().find(".shareTwitter").click(function(b){window.open(a(this).attr("href"),a.i18n.t("Share on Twitter"),"width=600,height=400");b.preventDefault()}).end().find("#shortenURL").click(function(){a(this).select()}).end().lightbox_me({centered:true});
a.ajax({url:"/shorten?custom_hostname="+encodeURIComponent(window.location.protocol+"//"+e)+"&path="+encodeURIComponent("/"+d),success:function(b){a("#shareURL").css("visibility","visible").find("#shortenURL").val(b.url).focus().select()}});b.preventDefault()},templates:{shareLaneDialog:'<div id="shareLaneDialog" class="memolaneDialog" style="width:400px">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">${shareDialogText}</div>\t\t<div class="close closeMemolaneDialog">'+a.i18n.t("close",
"close share dialog")+'</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<ul class="shareMemoOptions">\t\t\t<li><a href="http://www.facebook.com/share.php?u=${url}&amp;t=${shareText}" class="shareFacebook">'+a.i18n.t("Facebook","Facebook, the online web application")+'</a></li>\t\t\t<li><a href="http://twitter.com/share?via=memolane&amp;text=${shareText}&amp;url=${url}" class="shareTwitter">'+a.i18n.t("Twitter","Twitter, the online web application")+'</a></li>\t\t\t<li id="shareURL">\t\t\t\t<label>'+
a.i18n.t("Link:","a link to the page the user is sharing")+' <input id="shortenURL" type="text"></label>\t\t\t</li>\t\t</ul>\t</div></div>'}}}(this,jQuery,this.undefined);m.share.initialize();
m.search=function(e,a,b){return{$searchInput:a("#search-input"),$closeSearchBtn:a("#close-search-btn"),$searchDD:a("#dd-search"),$tbSearch:a("#tb-search"),$searchTypesA:a("#search-types a"),$searchResults:a(".search-results"),searchDDOpen:false,searchContext:m.currentLane?"search-memos":"search-lanes",loaderClass:"small-loader-on-grey",jScrollGutter:5,maxDDContentHeight:320,searchLaneScope:"world",searchTimeout:b,initialize:function(){m.currentLane||(a("#search-memos").hide(),a("#search-lanes").show(),
a("#search-lanes-filter-friends").show());var b=this;this.$searchInput.focus(a.proxy(this.searchInputFocus,this)).blur(a.proxy(this.searchInputBlur,this)).keyup(a.proxy(this.searchInputkeyup,this));this.$closeSearchBtn.bind(m.clickOrTouchStart,a.proxy(function(){this.closeSearchDD()},this));a(document).bind(m.clickOrTouchStart,a.proxy(this.closeSearchDDFromClickOff,this));this.$searchTypesA.bind(m.clickOrTouchStart,a.proxy(function(a){this.toggleSearchContext(a)},this));this.$searchResults.delegate(".request-friendship",
m.clickOrTouchStart,function(){b.addFriendDialog(a(this));return false});a("#search-lanes-filter-friends input").bind(m.clickOrTouchStart,function(){b.setLaneSearchFilter(a(this))})},searchInputFocus:function(b){var d=a(b.target),e=d.val();d.val(e===b.target.defaultValue?"":e).addClass("search-focused").data("hasFocus",true);this.$closeSearchBtn.show()},searchInputBlur:function(b){var d=a(b.target);this.$searchDD.css("visibility")!=="visible"&&(d.val(b.target.defaultValue).removeClass("search-focused").data("hasFocus",
false),this.$closeSearchBtn.hide(),this.$tbSearch.css("background-color","transparent"))},closeSearchDD:function(){this.$searchDD.css("visibility","hidden");this.$searchInput.trigger("blur");this.searchDDOpen=false},closeSearchDDFromClickOff:function(b){a(b.target).closest("#dd-search, #tb-search, .memolaneDialog").length||this.closeSearchDD()},searchInputkeyup:function(b){a(b.target);b=this.$searchInput.val();if(b.length!=0&&b.length>=3||this.searchDDOpen)this.searchDDOpen===false&&(this.$tbSearch.css("background-color",
"#f1f1f1"),this.openSearchDD()),this.doSearchDebounce(this.searchContext),foo=false},openSearchDD:function(){this.searchDDOpen=true;m.topBarDropDowns.closeAllDropdowns();this.$searchDD.css("visibility","visible")},toggleSearchContext:function(b){var d=a(b.target),e=d.attr("id").replace("dd-","");e==="search-lanes"?a("#search-lanes-filter-friends").show():a("#search-lanes-filter-friends").hide();this.searchContext=e;this.$searchResults.hide();this.$searchTypesA.removeClass("smallButtonActive");d.addClass("smallButtonActive");
this.doSearchDebounce(e);b.preventDefault()},setLaneSearchFilter:function(a){a.attr("id");this.searchLaneScope=a.is(":checked")===true?"friends":"world";this.doContextSearch(0,"search-lanes")},doSearchDebounce:_.debounce(function(a){this.doContextSearch(0,a)},200),doContextSearch:function(b,d,e){var g=this,f=a("#"+d).show(),k=f.find("ul"),j=this.$searchInput.val(),h="",i="",l="",e=e||10,p=a("#"+d+"-hits");g.searchContext=d;switch(d){case "search-memos":h="/search/memos";l="memos";i="";lane=m.currentLane.id;
break;case "search-lanes":h="/search/lanes";l="lanes";i=g.searchLaneScope;lane="";break;case "search-users":h="/search/users",l="users",i="world",lane=""}b==0&&(k.html(""),f.find(".search-results-scrollable").data("jsp")&&f.find(".search-results-scrollable").data("jsp").destroy(),f.show());a("#"+d+"-loader").show();e>b?a.ajax({type:"get",url:h,data:{q:j,start:b,limit:10,scope:i,lane:lane},success:function(e,i,h){a("#"+d+"-loader").hide();b==0&&f.removeClass(g.loaderClass);parseInt(e.hits)==0||h.status==
204?k.find(".search-no-results").length===0&&(a.tmpl(g.templates[d].empty,{}).appendTo(k),p.html(""),f.find(".search-results-scrollable").height(40)):(a.tmpl(g.templates[d].results,e[l]).appendTo(k),k.height()>=g.maxDDContentHeight?f.find(".search-results-scrollable").height(g.maxDDContentHeight).jScrollPane({verticalGutter:g.jScrollGutter}):f.find(".search-results-scrollable").height(k.height()),f.find(".jspScrollable").bind("jsp-scroll-y",function(f,h,i,j){j===true&&(f=b+10,e.hits>f&&g.doContextSearch(f,
d,e.hits),a(this).unbind("jsp-scroll-y"))}),b==0?p.html(e.hits+" "+a.i18n.t("total results","this is preceded by the number of search results returned")):f.find(".search-results-scrollable").data("jsp").reinitialise())}}):a("#"+d+"-loader").hide()},linkToMemo:function(a,b){return m.utilities.breakURLCache(window.location.pathname)+"#time="+b+"&memo="+m.utilities.cleanMemoId(a)},addFriendDialog:function(b){b={username:b.data("username"),first_name:b.data("first_name"),last_name:b.data("last_name")};
a.tmpl(m.globalTemplates.dialogs.addFriend,b).lightbox_me({centered:true});m.dashboard?m.dashboard.addFriend(b.username):a.ajax({type:"post",url:"/friends/"+b.username,success:function(){}})},templates:{"search-memos":{results:'<li class="clearfix"><a href="${m.search.linkToMemo(id, created_at)}" title="'+a.i18n.t("view memo")+'"><div class="search-service-icon ${service}-icon"></div><img src="/${user.username}/images" alt="lane" class="search-user-avatar" title="${title}" height="20" width="20" /><div class="search-memos-txt">${title.substring(0, 75) + ( title.length > 75 ? "..." : "") }<span class="search-memos-date">${m.utilities.dateFormat((created_at*1000), "UTC:ddd mmm dd yyyy HH:MM:ss")}</span></div></a></li>',
empty:'<li class="clearfix search-no-results">'+a.i18n.t("No memos match that search term")+"</li>"},"search-lanes":{results:'{{if user}}<li class="clearfix"><a href="/${user.username}/${title}" title="'+a.i18n.t("view lane")+'"><img src="/lanes/${id}/avatar.small" class="search-result-icon search-lane-image" alt="topBarAvatar" title="${title}" height="20" width="20" /><span class="search-results-txt">${title}{{if m.currentUser.userID != user_id}}<span class="search-lanes-rel">(${user.first_name} ${user.last_name})</span>{{/if}}</span></a></li>{{/if}}',
empty:'<li class="clearfix search-no-results">'+a.i18n.t("No lanes match that search term")+"</li>"},"search-users":{results:'<li class="clearfix"><a href="/${username}" title="'+a.i18n.t("view user profile")+'"><img src="/${username}/images" height="20" width="20" class="search-result-icon search-user-avatar" alt="'+a.i18n.t("top bar avatar","this labels the lane avatar")+'"/><span class="search-results-txt">${first_name} ${last_name}<span class="search-users-username">(${username})</span></span> {{if friend=="pending" || friend=="self" || friend=="accepted" || m.currentUser === null}}{{else}}<a href="#" data-first_name="${first_name}" data-last_name="${last_name}" data-username="${username}" class="request-friendship" title="'+
a.i18n.t("request friendship")+'">'+a.i18n.t("Request Friendship")+"</a>{{/if}}</a></li>",empty:'<li class="clearfix search-no-results">'+a.i18n.t("No users match that search term")+"</li>"}}}}(this,jQuery,this.undefined);m.search.initialize();$.fn.lightbox_me.defaults.destroyOnClose=true;$.fn.lightbox_me.defaults.centered=true;m.utilities.browser.init();var currentBrowser=m.utilities.browser;
(currentBrowser.browser==="Firefox"&&parseInt($.browser.version,10)<6||currentBrowser.browser==="Opera"&&parseInt($.browser.version,10)<11||currentBrowser.browser==="Explorer"&&parseInt($.browser.version,10)<9)&&$('<div class="notifications badnews-notice"><div class="notice-text">'+$.i18n.t("You appear to be using an older browser. Did it come with a free toaster? Memolane and the internet in general looks better with Explorer 9, Opera 11+, Chrome 12+, Firefox 6+, and Safari 5+, so please consider upgrading and come back to visit. P.S. The irony that we don't support viewing on mobile phones is not lost on us.")+
' <a href="#" class="close-notice">X</a></div></div>').notify({expires:false});
(m.deviceIsIphone||Modernizr.touch&&!m.deviceIsIpad&&!m.deviceIsAndroid||m.deviceIsAndroid&&!navigator.userAgent.toLowerCase().match(/android 3/i))&&$('<div class="notifications badnews-notice"><div class="notice-text">'+$.i18n.t("We're working on shrinking Memolane for mobile phones, in the meantime please check out Memolane on a larger screen. We suggest an iPad, Android tablet, or the desktop or laptop of your choice.")+' <a href="#" class="close-notice">X</a></div></div>').notify({expires:false});
$.ajaxSetup({data:{_csrf:m.csrf}});$.ajaxPrefilter(function(e){e.type.toLowerCase()==="delete"&&(e.data+="&_method=DELETE")});
